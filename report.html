<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Report Results</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.5.0/sql-wasm.js"></script>

    <style>
        body { font-family: Arial, sans-serif; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 8px; border: 1px solid #ddd; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>SQL Report Results</h1>
    <div id="result"></div>

    <script>

        // 加载 SQL 文件并执行
        const loadSQLFile = (filePath, callback) => {
            fetch(filePath)
                .then(response => response.text())
                .then(sqlQuery => {
                    callback(sqlQuery);
                })
                .catch(error => {
                    document.getElementById('result').innerHTML = `Error loading SQL file: ${error.message}`;
                });
        };

        // 执行 SQL 查询并显示结果
        const executeSQL = async (sqlQuery) => {
            const response = await fetch(SQL_FILE);
            const buffer = await response.arrayBuffer();
            const db = new SQL.Database(new Uint8Array(buffer));

            const results = db.exec(sqlQuery);
            const resultContainer = document.getElementById('result');
            
            if (results.length > 0) {
                const columns = results[0].columns;
                const values = results[0].values;

                let html = `<h2>${group} - ${name}</h2>`;
                html += '<table>';
                html += '<tr>' + columns.map(col => `<th>${col}</th>`).join('') + '</tr>';
                values.forEach(row => {
                    html += '<tr>' + row.map(cell => `<td>${cell}</td>`).join('') + '</tr>';
                });
                html += '</table>';
                resultContainer.innerHTML = html;
            } else {
                resultContainer.innerHTML = 'No data found for this report.';
            }
        };
        const SQL_FILE = 'Sample4GRM.mmb'; // SQLite 数据库文件路径

        // 从 URL 中获取参数
        const params = new URLSearchParams(window.location.search);
        const group = params.get('group'); // 获取报告组
        const name = params.get('name');   // 获取报告名

        if (!group || !name) {
            document.getElementById('result').innerHTML = 'Missing report group or name.';
        } else {
            // 通过 URL 参数构建 SQL 文件路径
            const sqlFilePath = `packages/${group}/${name}/sqlcontent.sql`;
            loadSQLFile(sqlFilePath, executeSQL);
        }

    </script>
</body>
</html>
